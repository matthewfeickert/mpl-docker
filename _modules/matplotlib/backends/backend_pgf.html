
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>matplotlib.backends.backend_pgf &#8212; Matplotlib 3.3.0rc1+229.g97785f2e6 documentation</title>
    <link rel="stylesheet" href="../../../_static/mpl.css?v3.3.0rc1-229-g97785f2e6" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-dataframe.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Matplotlib 3.3.0rc1+229.g97785f2e6 documentation"
          href="../../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>

    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link rel="top" title="Matplotlib 3.3.0rc1+229.g97785f2e6 documentation" href="#" />
    <link rel="canonical" href="https://matplotlib.org/devdocs/_modules/matplotlib/backends/backend_pgf.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>

<div id="unreleased-message">
    You are reading documentation for the unreleased version of Matplotlib.
    <a href="https://matplotlib.org/search.html?q=matplotlib.backends.backend_pgf&amp;check_keywords=yes&amp;area=default">
        Try searching for the released version of this page instead?
    </a>
</div>

<!--
<div id="annc-banner">

</div>
-->

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px; position: relative;">
    <a href="../../../index.html">
        <div style="float: left; position: absolute; width: 496px; bottom: 0; padding-bottom: 24px"><span style="float: right; color: #789; background: white">Version 3.3.0rc1+229.g97785f2e6</span></div>
        <img src="../../../_static/logo2_compressed.svg" height="125px" border="0" alt="matplotlib"/></a>

    <!-- The "Fork me on github" ribbon -->
    <div id="forkongithub"><a href="https://github.com/matplotlib/matplotlib">Fork me on GitHub</a></div>
    </div>

    <nav class="main-nav">
        <ul>
            <li><a href="../../../users/installing.html">Installation</a></li>
            <li><a href="../../../contents.html">Documentation</a></li>
            <li><a href="../../../gallery/index.html">Examples</a></li>
            <li><a href="../../../tutorials/index.html">Tutorials</a></li>
            <li><a href="../../../devel/index.html">Contributing</a></li>
            <li class="nav-right">
                <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" aria-labelledby="searchlabel" placeholder="Search"/>
                </form>
            </li>
        </ul>
     </nav>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">home</a>|&nbsp;</li>
        <li><a href="../../../contents.html">contents</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../matplotlib.html" accesskey="U">matplotlib</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">matplotlib.backends.backend_pgf</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../contents.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../matplotlib.html">matplotlib</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for matplotlib.backends.backend_pgf</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cbook</span><span class="p">,</span> <span class="n">font_manager</span> <span class="k">as</span> <span class="n">fm</span>
<span class="kn">from</span> <span class="nn">matplotlib.backend_bases</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_Backend</span><span class="p">,</span> <span class="n">_check_savefig_extra_args</span><span class="p">,</span> <span class="n">FigureCanvasBase</span><span class="p">,</span> <span class="n">FigureManagerBase</span><span class="p">,</span>
    <span class="n">GraphicsContextBase</span><span class="p">,</span> <span class="n">RendererBase</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_mixed</span> <span class="kn">import</span> <span class="n">MixedModeRenderer</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_create_pdf_info_dict</span><span class="p">,</span> <span class="n">_datetime_to_pdf</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib._pylab_helpers</span> <span class="kn">import</span> <span class="n">Gcf</span>

<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Note: When formatting floating point values, it is important to use the</span>
<span class="c1"># %f/{:f} format rather than %s/{} to avoid triggering scientific notation,</span>
<span class="c1"># which is not recognized by TeX.</span>


<div class="viewcode-block" id="get_fontspec"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.get_fontspec">[docs]</a><span class="k">def</span> <span class="nf">get_fontspec</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Build fontspec preamble from rc.&quot;&quot;&quot;</span>
    <span class="n">latex_fontspec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">texcommand</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;pgf.texsystem&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">texcommand</span> <span class="o">!=</span> <span class="s2">&quot;pdflatex&quot;</span><span class="p">:</span>
        <span class="n">latex_fontspec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">usepackage</span><span class="si">{fontspec}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">texcommand</span> <span class="o">!=</span> <span class="s2">&quot;pdflatex&quot;</span> <span class="ow">and</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;pgf.rcfonts&quot;</span><span class="p">]:</span>
        <span class="n">families</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;serif&quot;</span><span class="p">,</span> <span class="s2">&quot;sans</span><span class="se">\\</span><span class="s2">-serif&quot;</span><span class="p">,</span> <span class="s2">&quot;monospace&quot;</span><span class="p">]</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;setmainfont&quot;</span><span class="p">,</span> <span class="s2">&quot;setsansfont&quot;</span><span class="p">,</span> <span class="s2">&quot;setmonofont&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">family</span><span class="p">,</span> <span class="n">command</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">families</span><span class="p">,</span> <span class="n">commands</span><span class="p">):</span>
            <span class="c1"># 1) Forward slashes also work on Windows, so don&#39;t mess with</span>
            <span class="c1"># backslashes.  2) The dirname needs to include a separator.</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">findfont</span><span class="p">(</span><span class="n">family</span><span class="p">))</span>
            <span class="n">latex_fontspec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\</span><span class="si">%s</span><span class="s2">{</span><span class="si">%s</span><span class="s2">}[Path=</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">command</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">latex_fontspec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_preamble"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.get_preamble">[docs]</a><span class="k">def</span> <span class="nf">get_preamble</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get LaTeX preamble from rc.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;pgf.preamble&quot;</span><span class="p">]</span></div>

<span class="c1">###############################################################################</span>

<span class="c1"># This almost made me cry!!!</span>
<span class="c1"># In the end, it&#39;s better to use only one unit for all coordinates, since the</span>
<span class="c1"># arithmetic in latex seems to produce inaccurate conversions.</span>
<span class="n">latex_pt_to_in</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">72.27</span>
<span class="n">latex_in_to_pt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">latex_pt_to_in</span>
<span class="n">mpl_pt_to_in</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">72.</span>
<span class="n">mpl_in_to_pt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">mpl_pt_to_in</span>

<span class="c1">###############################################################################</span>
<span class="c1"># helper functions</span>

<span class="n">NO_ESCAPE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&lt;!</span><span class="se">\\</span><span class="s2">)(?:</span><span class="se">\\\\</span><span class="s2">)*&quot;</span>
<span class="n">re_mathsep</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NO_ESCAPE</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\$&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="repl_escapetext"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.repl_escapetext">[docs]</a><span class="nd">@cbook</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;3.2&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">repl_escapetext</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="repl_mathdefault"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.repl_mathdefault">[docs]</a><span class="nd">@cbook</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;3.2&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">repl_mathdefault</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span></div>


<span class="n">_replace_escapetext</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
    <span class="c1"># When the next character is _, ^, $, or % (not preceded by an escape),</span>
    <span class="c1"># insert a backslash.</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NO_ESCAPE</span> <span class="o">+</span> <span class="s2">&quot;(?=[_^$%])&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">_replace_mathdefault</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
    <span class="c1"># Replace \mathdefault (when not preceded by an escape) by empty string.</span>
    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NO_ESCAPE</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">mathdefault)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="common_texification"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.common_texification">[docs]</a><span class="k">def</span> <span class="nf">common_texification</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do some necessary and/or useful substitutions for texts to be included in</span>
<span class="sd">    LaTeX documents.</span>

<span class="sd">    This distinguishes text-mode and math-mode by replacing the math separator</span>
<span class="sd">    ``$`` with ``\(\displaystyle %s\)``. Escaped math separators (``\$``)</span>
<span class="sd">    are ignored.</span>

<span class="sd">    The following characters are escaped in text segments: ``_^$%``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sometimes, matplotlib adds the unknown command \mathdefault.</span>
    <span class="c1"># Not using \mathnormal instead since this looks odd for the latex cm font.</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">_replace_mathdefault</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="c1"># split text into normaltext and inline math parts</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">re_mathsep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># textmode replacements</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">_replace_escapetext</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># mathmode replacements</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\(\displaystyle </span><span class="si">%s</span><span class="s2">\)&quot;</span> <span class="o">%</span> <span class="n">s</span>
        <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeln"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.writeln">[docs]</a><span class="k">def</span> <span class="nf">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
    <span class="c1"># every line of a file included with \\input must be terminated with %</span>
    <span class="c1"># if not, latex will create additional vertical spaces for some reason</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_font_properties_str</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
    <span class="c1"># translate font properties to latex commands, return as string</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">families</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;serif&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\rmfamily&quot;</span><span class="p">,</span> <span class="s2">&quot;sans&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\sffamily&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sans-serif&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\sffamily&quot;</span><span class="p">,</span> <span class="s2">&quot;monospace&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\ttfamily&quot;</span><span class="p">}</span>
    <span class="n">family</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">get_family</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">family</span> <span class="ow">in</span> <span class="n">families</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">families</span><span class="p">[</span><span class="n">family</span><span class="p">])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">font</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">family</span> <span class="k">for</span> <span class="n">font</span> <span class="ow">in</span> <span class="n">fm</span><span class="o">.</span><span class="n">fontManager</span><span class="o">.</span><span class="n">ttflist</span><span class="p">)</span>
          <span class="ow">and</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;pgf.texsystem&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;pdflatex&quot;</span><span class="p">):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\setmainfont{</span><span class="si">%s</span><span class="s2">}\rmfamily&quot;</span> <span class="o">%</span> <span class="n">family</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># print warning?</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">get_size_in_points</span><span class="p">()</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\fontsize{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">))</span>

    <span class="n">styles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;italic&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\itshape&quot;</span><span class="p">,</span> <span class="s2">&quot;oblique&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\slshape&quot;</span><span class="p">}</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">styles</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">get_style</span><span class="p">()])</span>

    <span class="n">boldstyles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;semibold&quot;</span><span class="p">,</span> <span class="s2">&quot;demibold&quot;</span><span class="p">,</span> <span class="s2">&quot;demi&quot;</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="s2">&quot;heavy&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;extra bold&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">get_weight</span><span class="p">()</span> <span class="ow">in</span> <span class="n">boldstyles</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bfseries&quot;</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\selectfont&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_metadata_to_str</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert metadata key/value to a form that hyperref accepts.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">_datetime_to_pdf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Trapped&#39;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">=</span><span class="se">{{</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span>


<div class="viewcode-block" id="make_pdf_to_png_converter"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.make_pdf_to_png_converter">[docs]</a><span class="k">def</span> <span class="nf">make_pdf_to_png_converter</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a function that converts a pdf file to a png file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;pdftocairo&quot;</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">cairo_convert</span><span class="p">(</span><span class="n">pdffile</span><span class="p">,</span> <span class="n">pngfile</span><span class="p">,</span> <span class="n">dpi</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pdftocairo&quot;</span><span class="p">,</span> <span class="s2">&quot;-singlefile&quot;</span><span class="p">,</span> <span class="s2">&quot;-png&quot;</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dpi</span><span class="p">,</span>
                   <span class="n">pdffile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cairo_convert</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gs_info</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">_get_executable_info</span><span class="p">(</span><span class="s2">&quot;gs&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">mpl</span><span class="o">.</span><span class="n">ExecutableNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">gs_convert</span><span class="p">(</span><span class="n">pdffile</span><span class="p">,</span> <span class="n">pngfile</span><span class="p">,</span> <span class="n">dpi</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
                   <span class="s1">&#39;-dQUIET&#39;</span><span class="p">,</span> <span class="s1">&#39;-dSAFER&#39;</span><span class="p">,</span> <span class="s1">&#39;-dBATCH&#39;</span><span class="p">,</span> <span class="s1">&#39;-dNOPAUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;-dNOPROMPT&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;-dUseCIEColor&#39;</span><span class="p">,</span> <span class="s1">&#39;-dTextAlphaBits=4&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;-dGraphicsAlphaBits=4&#39;</span><span class="p">,</span> <span class="s1">&#39;-dDOINTERPOLATE&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;-sDEVICE=png16m&#39;</span><span class="p">,</span> <span class="s1">&#39;-sOutputFile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pngfile</span><span class="p">,</span>
                   <span class="s1">&#39;-r</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">pdffile</span><span class="p">]</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gs_convert</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No suitable pdf to png renderer found.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LatexError"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexError">[docs]</a><span class="k">class</span> <span class="nc">LatexError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">latex_output</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex_output</span> <span class="o">=</span> <span class="n">latex_output</span></div>


<div class="viewcode-block" id="LatexManager"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexManager">[docs]</a><span class="k">class</span> <span class="nc">LatexManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The LatexManager opens an instance of the LaTeX application for</span>
<span class="sd">    determining the metrics of text elements. The LaTeX environment can be</span>
<span class="sd">    modified by setting fonts and/or a custom preamble in `.rcParams`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_unclean_instances</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_build_latex_header</span><span class="p">():</span>
        <span class="n">latex_preamble</span> <span class="o">=</span> <span class="n">get_preamble</span><span class="p">()</span>
        <span class="n">latex_fontspec</span> <span class="o">=</span> <span class="n">get_fontspec</span><span class="p">()</span>
        <span class="c1"># Create LaTeX header with some content, else LaTeX will load some math</span>
        <span class="c1"># fonts later when we don&#39;t expect the additional output on stdout.</span>
        <span class="c1"># TODO: is this sufficient?</span>
        <span class="n">latex_header</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s2">&quot;\documentclass</span><span class="si">{minimal}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="c1"># Include TeX program name as a comment for cache invalidation.</span>
            <span class="c1"># TeX does not allow this to be the first line.</span>
            <span class="sa">rf</span><span class="s2">&quot;% !TeX program = </span><span class="si">{</span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pgf.texsystem&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="c1"># Test whether \includegraphics supports interpolate option.</span>
            <span class="sa">r</span><span class="s2">&quot;\usepackage</span><span class="si">{graphicx}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">latex_preamble</span><span class="p">,</span>
            <span class="n">latex_fontspec</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{document}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;text $math \mu$&quot;</span><span class="p">,</span>  <span class="c1"># force latex to load fonts now</span>
            <span class="sa">r</span><span class="s2">&quot;\typeout</span><span class="si">{pgf_backend_query_start}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">latex_header</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_cached_or_new</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the previous LatexManager if the header and tex system did not</span>
<span class="sd">        change, or a new instance otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_cached_or_new_impl</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_build_latex_header</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_cached_or_new_impl</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>  <span class="c1"># Helper for _get_cached_or_new.</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cleanup_remaining_instances</span><span class="p">():</span>
        <span class="n">unclean_instances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">LatexManager</span><span class="o">.</span><span class="n">_unclean_instances</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">latex_manager</span> <span class="ow">in</span> <span class="n">unclean_instances</span><span class="p">:</span>
            <span class="n">latex_manager</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stdin_writeln</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_latex_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chars</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):]</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">latex</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="n">LatexError</span><span class="p">(</span><span class="s2">&quot;LaTeX process halted&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expect_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># store references for __del__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_os_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutil</span> <span class="o">=</span> <span class="n">shutil</span>

        <span class="c1"># create a tmp directory for running latex, remember to cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;mpl_pgf_lm_&quot;</span><span class="p">)</span>
        <span class="n">LatexManager</span><span class="o">.</span><span class="n">_unclean_instances</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># test the LaTeX setup to ensure a clean startup of the subprocess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;pgf.texsystem&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex_header</span> <span class="o">=</span> <span class="n">LatexManager</span><span class="o">.</span><span class="n">_build_latex_header</span><span class="p">()</span>
        <span class="n">latex_end</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\\</span><span class="s2">makeatletter</span><span class="se">\n\\</span><span class="s2">@@end</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">latex</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span><span class="p">,</span> <span class="s2">&quot;-halt-on-error&quot;</span><span class="p">],</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span><span class="si">}</span><span class="s2"> not found.  Install it or change &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;rcParams[&#39;pgf.texsystem&#39;] to an available TeX &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;implementation.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error starting process </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="n">test_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_header</span> <span class="o">+</span> <span class="n">latex_end</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">latex</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latex</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LatexError</span><span class="p">(</span><span class="s2">&quot;LaTeX returned an error, probably missing font &quot;</span>
                             <span class="s2">&quot;or error in preamble:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stdout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">latex</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be set up on first use.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># cache for strings already processed</span>

    <span class="k">def</span> <span class="nf">_setup_latex_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># open LaTeX process for real work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latex</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">texcommand</span><span class="p">,</span> <span class="s2">&quot;-halt-on-error&quot;</span><span class="p">],</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="c1"># write header with &#39;pgf_backend_query_start&#39; token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdin_writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_latex_header</span><span class="p">())</span>
        <span class="c1"># read all lines until our &#39;pgf_backend_query_start&#39; token appears</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect</span><span class="p">(</span><span class="s2">&quot;*pgf_backend_query_start&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect_prompt</span><span class="p">()</span>

<div class="viewcode-block" id="LatexManager.latex_stdin_utf8"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexManager.latex_stdin_utf8">[docs]</a>    <span class="nd">@cbook</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;3.3&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">latex_stdin_utf8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">stdin</span></div>

    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_os_path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latex</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">LatexManager</span><span class="o">.</span><span class="n">_unclean_instances</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;error deleting tmp directory </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;deleting LatexManager&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>

<div class="viewcode-block" id="LatexManager.get_width_height_descent"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.LatexManager.get_width_height_descent">[docs]</a>    <span class="k">def</span> <span class="nf">get_width_height_descent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the width, total height and descent for a text typeset by the</span>
<span class="sd">        current LaTeX environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># apply font properties and define textbox</span>
        <span class="n">prop_cmds</span> <span class="o">=</span> <span class="n">_font_properties_str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">textbox</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">sbox0{</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop_cmds</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c1"># check cache</span>
        <span class="k">if</span> <span class="n">textbox</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_cache</span><span class="p">[</span><span class="n">textbox</span><span class="p">]</span>

        <span class="c1"># send textbox to LaTeX and wait for prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdin_writeln</span><span class="p">(</span><span class="n">textbox</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expect_prompt</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">LatexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error processing &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">LaTeX Output:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">latex_output</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># typeout width, height and text offset of the last textbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdin_writeln</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\typeout{\the\wd0,\the\ht0,\the\dp0}&quot;</span><span class="p">)</span>
        <span class="c1"># read answer from latex and advance to the next prompt</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect_prompt</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">LatexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error processing &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">LaTeX Output:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">latex_output</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># parse metrics from the answer string</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error processing &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">LaTeX Output:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">answer</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">height</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">offset</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># the height returned from LaTeX goes from base to top.</span>
        <span class="c1"># the height matplotlib expects goes from bottom to top.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str_cache</span><span class="p">[</span><span class="n">textbox</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span> <span class="n">o</span></div></div>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_get_image_inclusion_command</span><span class="p">():</span>
    <span class="n">man</span> <span class="o">=</span> <span class="n">LatexManager</span><span class="o">.</span><span class="n">_get_cached_or_new</span><span class="p">()</span>
    <span class="n">man</span><span class="o">.</span><span class="n">_stdin_writeln</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;\includegraphics[interpolate=true]{</span><span class="si">%s</span><span class="s2">}&quot;</span>
        <span class="c1"># Don&#39;t mess with backslashes on Windows.</span>
        <span class="o">%</span> <span class="n">cbook</span><span class="o">.</span><span class="n">_get_data_path</span><span class="p">(</span><span class="s2">&quot;images/matplotlib.png&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">man</span><span class="o">.</span><span class="n">_expect_prompt</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s2">&quot;\includegraphics&quot;</span>
    <span class="k">except</span> <span class="n">LatexError</span><span class="p">:</span>
        <span class="c1"># Discard the broken manager.</span>
        <span class="n">LatexManager</span><span class="o">.</span><span class="n">_get_cached_or_new_impl</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s2">&quot;\pgfimage&quot;</span>


<div class="viewcode-block" id="RendererPgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf">[docs]</a><span class="k">class</span> <span class="nc">RendererPgf</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>

    <span class="nd">@cbook</span><span class="o">.</span><span class="n">_delete_parameter</span><span class="p">(</span><span class="s2">&quot;3.3&quot;</span><span class="p">,</span> <span class="s2">&quot;dummy&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">dummy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new PGF renderer that translates any drawing instruction</span>
<span class="sd">        into text commands to be interpreted in a latex pgfpicture environment.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        figure : `matplotlib.figure.Figure`</span>
<span class="sd">            Matplotlib figure to initialize height, width and dpi from.</span>
<span class="sd">        fh : file-like</span>
<span class="sd">            File handle for the output of the drawing commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">RendererBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">dpi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">fh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">figure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_latexManager</span> <span class="o">=</span> <span class="n">LatexManager</span><span class="o">.</span><span class="n">_get_cached_or_new</span><span class="p">()</span>  <span class="c1"># deprecated</span>

        <span class="k">if</span> <span class="n">dummy</span><span class="p">:</span>
            <span class="c1"># dummy==True deactivate all methods</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">RendererPgf</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;draw_&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span>

    <span class="n">latexManager</span> <span class="o">=</span> <span class="n">cbook</span><span class="o">.</span><span class="n">_deprecate_privatize_attribute</span><span class="p">(</span><span class="s2">&quot;3.2&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RendererPgf.draw_markers"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_markers">[docs]</a>    <span class="k">def</span> <span class="nf">draw_markers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">marker_path</span><span class="p">,</span> <span class="n">marker_trans</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span>
                     <span class="n">rgbFace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>

        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># convert from display units to in</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>

        <span class="c1"># set style and clip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_clip</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path_styles</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>

        <span class="c1"># build marker definition</span>
        <span class="n">bl</span><span class="p">,</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">marker_path</span><span class="o">.</span><span class="n">get_extents</span><span class="p">(</span><span class="n">marker_trans</span><span class="p">)</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">bl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">bl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;\pgfsys@defobject</span><span class="si">{currentmarker}</span><span class="s2">&quot;</span>
                <span class="sa">r</span><span class="s2">&quot;{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}{&quot;</span> <span class="o">%</span> <span class="n">coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker_path</span><span class="p">,</span> <span class="n">marker_trans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pgf_path_draw</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="n">fill</span><span class="o">=</span><span class="n">rgbFace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>

        <span class="c1"># draw marker for each vertex</span>
        <span class="k">for</span> <span class="n">point</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iter_segments</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsys@transformshift{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsys@useobject</span><span class="si">{currentmarker}{}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.draw_path"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_path">[docs]</a>    <span class="k">def</span> <span class="nf">draw_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">rgbFace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># draw the path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_clip</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path_styles</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pgf_path_draw</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="n">fill</span><span class="o">=</span><span class="n">rgbFace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># if present, draw pattern on top</span>
        <span class="k">if</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_hatch</span><span class="p">():</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path_styles</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>

            <span class="c1"># combine clip and path for clipping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_clip</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfusepath</span><span class="si">{clip}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># build pattern definition</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">&quot;\pgfsys@defobject</span><span class="si">{currentpattern}</span><span class="s2">&quot;</span>
                    <span class="sa">r</span><span class="s2">&quot;{\pgfqpoint</span><span class="si">{0in}{0in}</span><span class="s2">}{\pgfqpoint</span><span class="si">{1in}{1in}</span><span class="s2">}{&quot;</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">&quot;\pgfpathrectangle&quot;</span>
                    <span class="sa">r</span><span class="s2">&quot;{\pgfqpoint</span><span class="si">{0in}{0in}</span><span class="s2">}{\pgfqpoint</span><span class="si">{1in}{1in}</span><span class="s2">}&quot;</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfusepath</span><span class="si">{clip}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Affine2D</span><span class="p">()</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_hatch_path</span><span class="p">(),</span> <span class="n">scale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pgf_path_draw</span><span class="p">(</span><span class="n">stroke</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
            <span class="c1"># repeat pattern, filling the bounding rect of the path</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>
            <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> \
                <span class="n">path</span><span class="o">.</span><span class="n">get_extents</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="n">xmax</span>
            <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="n">ymax</span>
            <span class="n">repx</span><span class="p">,</span> <span class="n">repy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">&quot;\pgfsys@transformshift{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repy</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repx</span><span class="p">):</span>
                    <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsys@useobject</span><span class="si">{currentpattern}{}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsys@transformshift</span><span class="si">{1in}{0in}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsys@transformshift{-</span><span class="si">%d</span><span class="s2">in}</span><span class="si">{0in}</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">repx</span><span class="p">)</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsys@transformshift</span><span class="si">{0in}{1in}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_print_pgf_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>
        <span class="c1"># check for clip box</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_clip_rectangle</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bbox</span><span class="p">:</span>
            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">w</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">f</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">&quot;\pgfpathrectangle&quot;</span>
                    <span class="sa">r</span><span class="s2">&quot;{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}&quot;</span>
                    <span class="o">%</span> <span class="n">coords</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfusepath</span><span class="si">{clip}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># check for clip path</span>
        <span class="n">clippath</span><span class="p">,</span> <span class="n">clippath_trans</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_clip_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clippath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_path</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">clippath</span><span class="p">,</span> <span class="n">clippath_trans</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfusepath</span><span class="si">{clip}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print_pgf_path_styles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">rgbFace</span><span class="p">):</span>
        <span class="c1"># cap style</span>
        <span class="n">capstyles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;butt&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetbuttcap&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;round&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetroundcap&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;projecting&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetrectcap&quot;</span><span class="p">}</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="n">capstyles</span><span class="p">[</span><span class="n">gc</span><span class="o">.</span><span class="n">get_capstyle</span><span class="p">()])</span>

        <span class="c1"># join style</span>
        <span class="n">joinstyles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;miter&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetmiterjoin&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;round&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetroundjoin&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;bevel&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetbeveljoin&quot;</span><span class="p">}</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="n">joinstyles</span><span class="p">[</span><span class="n">gc</span><span class="o">.</span><span class="n">get_joinstyle</span><span class="p">()])</span>

        <span class="c1"># filling</span>
        <span class="n">has_fill</span> <span class="o">=</span> <span class="n">rgbFace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_forced_alpha</span><span class="p">():</span>
            <span class="n">fillopacity</span> <span class="o">=</span> <span class="n">strokeopacity</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strokeopacity</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_rgb</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">fillopacity</span> <span class="o">=</span> <span class="n">rgbFace</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">has_fill</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgbFace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">has_fill</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">&quot;\definecolor</span><span class="si">{currentfill}{rgb}</span><span class="s2">{</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">}&quot;</span>
                    <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rgbFace</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetfillcolor</span><span class="si">{currentfill}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_fill</span> <span class="ow">and</span> <span class="n">fillopacity</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetfillopacity{</span><span class="si">%f</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">fillopacity</span><span class="p">)</span>

        <span class="c1"># linewidth and color</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">()</span> <span class="o">*</span> <span class="n">mpl_pt_to_in</span> <span class="o">*</span> <span class="n">latex_in_to_pt</span>
        <span class="n">stroke_rgba</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_rgb</span><span class="p">()</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetlinewidth{</span><span class="si">%f</span><span class="s2">pt}&quot;</span> <span class="o">%</span> <span class="n">lw</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;\definecolor</span><span class="si">{currentstroke}{rgb}</span><span class="s2">{</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">}&quot;</span>
                <span class="o">%</span> <span class="n">stroke_rgba</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetstrokecolor</span><span class="si">{currentstroke}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strokeopacity</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetstrokeopacity{</span><span class="si">%f</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">strokeopacity</span><span class="p">)</span>

        <span class="c1"># line style</span>
        <span class="n">dash_offset</span><span class="p">,</span> <span class="n">dash_list</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_dashes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dash_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetdash</span><span class="si">{}{0pt}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">&quot;\pgfsetdash{</span><span class="si">%s</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">pt}&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;{</span><span class="si">%f</span><span class="s2">pt}&quot;</span> <span class="o">%</span> <span class="n">dash</span> <span class="k">for</span> <span class="n">dash</span> <span class="ow">in</span> <span class="n">dash_list</span><span class="p">),</span>
                       <span class="n">dash_offset</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_print_pgf_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">rgbFace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>
        <span class="c1"># check for clip box / ignore clip for filled paths</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_clip_rectangle</span><span class="p">()</span> <span class="k">if</span> <span class="n">gc</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">bbox</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rgbFace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># build path</span>
        <span class="k">for</span> <span class="n">points</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iter_segments</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">MOVETO</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;\pgfpathmoveto{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="n">y</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">CLOSEPOLY</span><span class="p">:</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfpathclose&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;\pgfpathlineto{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="n">y</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">CURVE3</span><span class="p">:</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">px</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">py</span> <span class="o">*</span> <span class="n">f</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;\pgfpathquadraticcurveto&quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}&quot;</span>
                        <span class="o">%</span> <span class="n">coords</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">CURVE4</span><span class="p">:</span>
                <span class="n">c1x</span><span class="p">,</span> <span class="n">c1y</span><span class="p">,</span> <span class="n">c2x</span><span class="p">,</span> <span class="n">c2y</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">c1x</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">c1y</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">c2x</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">c2y</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">px</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">py</span> <span class="o">*</span> <span class="n">f</span>
                <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">&quot;\pgfpathcurveto&quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}&quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}&quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}&quot;</span>
                        <span class="o">%</span> <span class="n">coords</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pgf_path_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stroke</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">stroke</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;stroke&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fill</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfusepath{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actions</span><span class="p">))</span>

<div class="viewcode-block" id="RendererPgf.option_scale_image"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.option_scale_image">[docs]</a>    <span class="k">def</span> <span class="nf">option_scale_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="RendererPgf.option_image_nocomposite"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.option_image_nocomposite">[docs]</a>    <span class="k">def</span> <span class="nf">option_image_nocomposite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.composite_image&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="RendererPgf.draw_image"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_image">[docs]</a>    <span class="k">def</span> <span class="nf">draw_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>

        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
            <span class="n">cbook</span><span class="o">.</span><span class="n">_warn_external</span><span class="p">(</span>
                <span class="s2">&quot;streamed pgf-code does not support raster graphics, consider &quot;</span>
                <span class="s2">&quot;using the pgf-to-pdf option.&quot;</span><span class="p">)</span>

        <span class="c1"># save the images to png files</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">fname_img</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-img</span><span class="si">%d</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_counter</span><span class="p">)</span>
        <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">im</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">fname_img</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># reference the image in the pgf picture</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_clip</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>  <span class="c1"># from display coords to inch</span>
        <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">&quot;\pgfsys@transformshift{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">f</span><span class="p">))</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">f</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">,</span> <span class="n">tr4</span><span class="p">,</span> <span class="n">tr5</span><span class="p">,</span> <span class="n">tr6</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">frozen</span><span class="p">()</span><span class="o">.</span><span class="n">to_values</span><span class="p">()</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                    <span class="sa">r</span><span class="s2">&quot;\pgfsys@transformcm{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">}{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">tr1</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr2</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr3</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">tr4</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">tr5</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">tr6</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span><span class="p">))</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># scale is already included in the transform</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># interpolation in PDF reader</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;\pgftext[left,bottom]&quot;</span>
                <span class="sa">r</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">[interpolate=</span><span class="si">%s</span><span class="s2">,width=</span><span class="si">%f</span><span class="s2">in,height=</span><span class="si">%f</span><span class="s2">in]{</span><span class="si">%s</span><span class="s2">}}&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">_get_image_inclusion_command</span><span class="p">(),</span>
                 <span class="n">interp</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">fname_img</span><span class="p">))</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.draw_tex"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_tex">[docs]</a>    <span class="k">def</span> <span class="nf">draw_tex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">ismath</span><span class="o">=</span><span class="s2">&quot;TeX!&quot;</span><span class="p">,</span> <span class="n">mtext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">ismath</span><span class="p">,</span> <span class="n">mtext</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.draw_text"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.draw_text">[docs]</a>    <span class="k">def</span> <span class="nf">draw_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">ismath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mtext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>

        <span class="c1"># prepare string for tex</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">common_texification</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">prop_cmds</span> <span class="o">=</span> <span class="n">_font_properties_str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop_cmds</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">alpha</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetfillopacity{</span><span class="si">%f</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetstrokeopacity{</span><span class="si">%f</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">get_rgb</span><span class="p">())[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\definecolor</span><span class="si">{textcolor}{rgb}</span><span class="s2">{</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">rgb</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetstrokecolor</span><span class="si">{textcolor}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfsetfillcolor</span><span class="si">{textcolor}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\color</span><span class="si">{textcolor}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">s</span>

        <span class="n">dpi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">dpi</span>
        <span class="n">text_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">mtext</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">angle</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
                 <span class="n">mtext</span><span class="o">.</span><span class="n">get_rotation_mode</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;anchor&quot;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">mtext</span><span class="o">.</span><span class="n">get_verticalalignment</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;center_baseline&quot;</span><span class="p">):</span>
            <span class="c1"># if text anchoring can be supported, get the original coordinates</span>
            <span class="c1"># and add alignment information</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">mtext</span><span class="o">.</span><span class="n">get_unitless_position</span><span class="p">()</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mtext</span><span class="o">.</span><span class="n">get_transform</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">halign</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
            <span class="n">valign</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">&quot;x=</span><span class="si">{</span><span class="n">x</span><span class="o">/</span><span class="n">dpi</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">in&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;y=</span><span class="si">{</span><span class="n">y</span><span class="o">/</span><span class="n">dpi</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">in&quot;</span><span class="p">,</span>
                <span class="n">halign</span><span class="p">[</span><span class="n">mtext</span><span class="o">.</span><span class="n">get_horizontalalignment</span><span class="p">()],</span>
                <span class="n">valign</span><span class="p">[</span><span class="n">mtext</span><span class="o">.</span><span class="n">get_verticalalignment</span><span class="p">()],</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if not, use the text layout provided by Matplotlib.</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x=</span><span class="si">{</span><span class="n">x</span><span class="o">/</span><span class="n">dpi</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">in, y=</span><span class="si">{</span><span class="n">y</span><span class="o">/</span><span class="n">dpi</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2">in, left, base&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">angle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">text_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;rotate=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">angle</span><span class="p">)</span>

        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgftext[</span><span class="si">%s</span><span class="s2">]{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_args</span><span class="p">),</span> <span class="n">s</span><span class="p">))</span>
        <span class="n">writeln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{pgfscope}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.get_text_width_height_descent"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.get_text_width_height_descent">[docs]</a>    <span class="k">def</span> <span class="nf">get_text_width_height_descent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">ismath</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>

        <span class="c1"># check if the math is supposed to be displaystyled</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">common_texification</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># get text metrics in units of latex pt, convert to display units</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">LatexManager</span><span class="o">.</span><span class="n">_get_cached_or_new</span><span class="p">()</span>
                   <span class="o">.</span><span class="n">get_width_height_descent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>
        <span class="c1"># TODO: this should be latex_pt_to_in instead of mpl_pt_to_in</span>
        <span class="c1"># but having a little bit more space around the text looks better,</span>
        <span class="c1"># plus the bounding box reported by LaTeX is VERY narrow</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">mpl_pt_to_in</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span>
        <span class="k">return</span> <span class="n">w</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">f</span></div>

<div class="viewcode-block" id="RendererPgf.flipy"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.flipy">[docs]</a>    <span class="k">def</span> <span class="nf">flipy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RendererPgf.get_canvas_width_height"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.get_canvas_width_height">[docs]</a>    <span class="k">def</span> <span class="nf">get_canvas_width_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span></div>

<div class="viewcode-block" id="RendererPgf.points_to_pixels"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.RendererPgf.points_to_pixels">[docs]</a>    <span class="k">def</span> <span class="nf">points_to_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>
        <span class="k">return</span> <span class="n">points</span> <span class="o">*</span> <span class="n">mpl_pt_to_in</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span></div></div>


<div class="viewcode-block" id="GraphicsContextPgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.GraphicsContextPgf">[docs]</a><span class="nd">@cbook</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;3.3&quot;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;GraphicsContextBase&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GraphicsContextPgf</span><span class="p">(</span><span class="n">GraphicsContextBase</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="TmpDirCleaner"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.TmpDirCleaner">[docs]</a><span class="k">class</span> <span class="nc">TmpDirCleaner</span><span class="p">:</span>
    <span class="n">remaining_tmpdirs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="TmpDirCleaner.add"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.TmpDirCleaner.add">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">remaining_tmpdirs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="TmpDirCleaner.cleanup_remaining_tmpdirs"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.TmpDirCleaner.cleanup_remaining_tmpdirs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup_remaining_tmpdirs</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tmpdir</span> <span class="ow">in</span> <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">remaining_tmpdirs</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;error deleting tmp directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span>
                <span class="n">tmpdir</span><span class="p">,</span>
                <span class="n">onerror</span><span class="o">=</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="FigureCanvasPgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf">[docs]</a><span class="k">class</span> <span class="nc">FigureCanvasPgf</span><span class="p">(</span><span class="n">FigureCanvasBase</span><span class="p">):</span>
    <span class="n">filetypes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pgf&quot;</span><span class="p">:</span> <span class="s2">&quot;LaTeX PGF picture&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;pdf&quot;</span><span class="p">:</span> <span class="s2">&quot;LaTeX compiled PGF picture&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;png&quot;</span><span class="p">:</span> <span class="s2">&quot;Portable Network Graphics&quot;</span><span class="p">,</span> <span class="p">}</span>

<div class="viewcode-block" id="FigureCanvasPgf.get_default_filetype"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.get_default_filetype">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_filetype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;pdf&#39;</span></div>

    <span class="nd">@_check_savefig_extra_args</span>
    <span class="nd">@cbook</span><span class="o">.</span><span class="n">_delete_parameter</span><span class="p">(</span><span class="s2">&quot;3.2&quot;</span><span class="p">,</span> <span class="s2">&quot;dryrun&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_print_pgf_to_fh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                         <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bbox_inches_restore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
            <span class="n">renderer</span> <span class="o">=</span> <span class="n">RendererPgf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dummy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">header_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">%%</span><span class="s2"> Creator: Matplotlib, PGF backend</span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> To include the figure in your LaTeX document, write</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">input{&lt;filename&gt;.pgf}</span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> Make sure the required packages are loaded in your preamble</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">usepackage</span><span class="si">{pgf}</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> and, on pdftex</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">usepackage[utf8]</span><span class="si">{inputenc}</span><span class="se">\\</span><span class="s2">DeclareUnicodeCharacter</span><span class="si">{2212}</span><span class="s2">{-}</span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> or, on luatex and xetex</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">usepackage{unicode-math}</span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> Figures using additional raster images can only be included by </span><span class="se">\\</span><span class="s2">input if</span>
<span class="si">%%</span><span class="s2"> they are in the same directory as the main LaTeX file. For loading figures</span>
<span class="si">%%</span><span class="s2"> from other directories you can use the `import` package</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">usepackage</span><span class="si">{import}</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"></span>
<span class="si">%%</span><span class="s2"> and then include the figures with</span>
<span class="si">%%</span><span class="s2">   </span><span class="se">\\</span><span class="s2">import{&lt;path to file&gt;}{&lt;filename&gt;.pgf}</span>
<span class="si">%%</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="c1"># append the preamble used by the backend as a comment for debugging</span>
        <span class="n">header_info_preamble</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%%</span><span class="s2"> Matplotlib used the following preamble&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">get_preamble</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">header_info_preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%%</span><span class="s2">   &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">get_fontspec</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">header_info_preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%%</span><span class="s2">   &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">header_info_preamble</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">header_info_preamble</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header_info_preamble</span><span class="p">)</span>

        <span class="c1"># get figure size in inch</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_dpi</span><span class="p">()</span>

        <span class="c1"># create pgfpicture environment and write the pgf code</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_text</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header_info_preamble</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begingroup&quot;</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\makeatletter&quot;</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\begin</span><span class="si">{pgfpicture}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">&quot;\pgfpathrectangle{\pgfpointorigin}{\pgfqpoint{</span><span class="si">%f</span><span class="s2">in}{</span><span class="si">%f</span><span class="s2">in}}&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\pgfusepath{use as bounding box, clip}&quot;</span><span class="p">)</span>
        <span class="n">renderer</span> <span class="o">=</span> <span class="n">MixedModeRenderer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span>
                                     <span class="n">RendererPgf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">fh</span><span class="p">),</span>
                                     <span class="n">bbox_inches_restore</span><span class="o">=</span><span class="n">bbox_inches_restore</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

        <span class="c1"># end the pgfpicture environment</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\end</span><span class="si">{pgfpicture}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\makeatother&quot;</span><span class="p">)</span>
        <span class="n">writeln</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\endgroup&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FigureCanvasPgf.print_pgf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.print_pgf">[docs]</a>    <span class="k">def</span> <span class="nf">print_pgf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_or_fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output pgf macros for drawing the figure so it can be included and</span>
<span class="sd">        rendered in latex documents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dryrun&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="n">cbook</span><span class="o">.</span><span class="n">open_file_cm</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbook</span><span class="o">.</span><span class="n">file_requires_unicode</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getwriter</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_print_pdf_to_fh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figwidth</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_figheight</span><span class="p">()</span>

        <span class="n">info_dict</span> <span class="o">=</span> <span class="n">_create_pdf_info_dict</span><span class="p">(</span><span class="s1">&#39;pgf&#39;</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">hyperref_options</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">_metadata_to_str</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">info_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># create temporary directory for compiling the figure</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;mpl_pgf_&quot;</span><span class="p">)</span>
            <span class="n">fname_pgf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;figure.pgf&quot;</span><span class="p">)</span>
            <span class="n">fname_tex</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;figure.tex&quot;</span><span class="p">)</span>
            <span class="n">fname_pdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;figure.pdf&quot;</span><span class="p">)</span>

            <span class="c1"># print figure to pgf and compile it with latex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_pgf</span><span class="p">(</span><span class="n">fname_pgf</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">latex_preamble</span> <span class="o">=</span> <span class="n">get_preamble</span><span class="p">()</span>
            <span class="n">latex_fontspec</span> <span class="o">=</span> <span class="n">get_fontspec</span><span class="p">()</span>
            <span class="n">latexcode</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="se">\\</span><span class="s2">PassOptionsToPackage{pdfinfo={</span><span class="si">%s</span><span class="s2">}}</span><span class="si">{hyperref}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">RequirePackage</span><span class="si">{hyperref}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">documentclass[12pt]</span><span class="si">{minimal}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">usepackage[paperwidth=</span><span class="si">%f</span><span class="s2">in, paperheight=</span><span class="si">%f</span><span class="s2">in, margin=0in]</span><span class="si">{geometry}</span><span class="s2"></span>
<span class="si">%s</span><span class="s2"></span>
<span class="si">%s</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">usepackage</span><span class="si">{pgf}</span><span class="s2"></span>

<span class="se">\\</span><span class="s2">begin</span><span class="si">{document}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">centering</span>
<span class="se">\\</span><span class="s2">input</span><span class="si">{figure.pgf}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">end</span><span class="si">{document}</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hyperref_options</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">latex_preamble</span><span class="p">,</span> <span class="n">latex_fontspec</span><span class="p">)</span>
            <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fname_tex</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">latexcode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

            <span class="n">texcommand</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;pgf.texsystem&quot;</span><span class="p">]</span>
            <span class="n">cbook</span><span class="o">.</span><span class="n">_check_and_log_subprocess</span><span class="p">(</span>
                <span class="p">[</span><span class="n">texcommand</span><span class="p">,</span> <span class="s2">&quot;-interaction=nonstopmode&quot;</span><span class="p">,</span> <span class="s2">&quot;-halt-on-error&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;figure.tex&quot;</span><span class="p">],</span> <span class="n">_log</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span>

            <span class="c1"># copy file contents to target</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_pdf</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh_src</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">fh_src</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="FigureCanvasPgf.print_pdf"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.print_pdf">[docs]</a>    <span class="k">def</span> <span class="nf">print_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_or_fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use LaTeX to compile a Pgf generated figure to PDF.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dryrun&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="n">cbook</span><span class="o">.</span><span class="n">open_file_cm</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pdf_to_fh</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_print_png_to_fh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">make_pdf_to_png_converter</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># create temporary directory for pdf creation and png conversion</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;mpl_pgf_&quot;</span><span class="p">)</span>
            <span class="n">fname_pdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;figure.pdf&quot;</span><span class="p">)</span>
            <span class="n">fname_png</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;figure.png&quot;</span><span class="p">)</span>
            <span class="c1"># create pdf and try to convert it to png</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_pdf</span><span class="p">(</span><span class="n">fname_pdf</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">converter</span><span class="p">(</span><span class="n">fname_pdf</span><span class="p">,</span> <span class="n">fname_png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
            <span class="c1"># copy file contents to target</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname_png</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh_src</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">fh_src</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="FigureCanvasPgf.print_png"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.print_png">[docs]</a>    <span class="k">def</span> <span class="nf">print_png</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_or_fh</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use LaTeX to compile a pgf figure to pdf and convert it to png.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dryrun&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_pgf_to_fh</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="n">cbook</span><span class="o">.</span><span class="n">open_file_cm</span><span class="p">(</span><span class="n">fname_or_fh</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_png_to_fh</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="FigureCanvasPgf.get_renderer"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.FigureCanvasPgf.get_renderer">[docs]</a>    <span class="k">def</span> <span class="nf">get_renderer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RendererPgf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div></div>


<span class="n">FigureManagerPgf</span> <span class="o">=</span> <span class="n">FigureManagerBase</span>


<span class="nd">@_Backend</span><span class="o">.</span><span class="n">export</span>
<span class="k">class</span> <span class="nc">_BackendPgf</span><span class="p">(</span><span class="n">_Backend</span><span class="p">):</span>
    <span class="n">FigureCanvas</span> <span class="o">=</span> <span class="n">FigureCanvasPgf</span>


<span class="k">def</span> <span class="nf">_cleanup_all</span><span class="p">():</span>
    <span class="n">LatexManager</span><span class="o">.</span><span class="n">_cleanup_remaining_instances</span><span class="p">()</span>
    <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">cleanup_remaining_tmpdirs</span><span class="p">()</span>


<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">_cleanup_all</span><span class="p">)</span>


<div class="viewcode-block" id="PdfPages"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.PdfPages">[docs]</a><span class="k">class</span> <span class="nc">PdfPages</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A multi-page PDF file using the pgf backend</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; # Initialize:</span>
<span class="sd">    &gt;&gt;&gt; with PdfPages(&#39;foo.pdf&#39;) as pdf:</span>
<span class="sd">    ...     # As many times as you like, create a figure fig and save it:</span>
<span class="sd">    ...     fig = plt.figure()</span>
<span class="sd">    ...     pdf.savefig(fig)</span>
<span class="sd">    ...     # When no figure is specified the current figure is saved</span>
<span class="sd">    ...     pdf.savefig()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;_outputfile&#39;</span><span class="p">,</span>
        <span class="s1">&#39;keep_empty&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_tmpdir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_basename&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_fname_tex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_fname_pdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_n_figures&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_file&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_info_dict&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_metadata&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keep_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new PdfPages object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str or path-like</span>
<span class="sd">            Plots using `PdfPages.savefig` will be written to a file at this</span>
<span class="sd">            location. Any older file with the same name is overwritten.</span>
<span class="sd">        keep_empty : bool, default: True</span>
<span class="sd">            If set to False, then empty pdf files will be deleted automatically</span>
<span class="sd">            when closed.</span>
<span class="sd">        metadata : dict, optional</span>
<span class="sd">            Information dictionary object (see PDF reference section 10.2.1</span>
<span class="sd">            &#39;Document Information Dictionary&#39;), e.g.:</span>
<span class="sd">            ``{&#39;Creator&#39;: &#39;My software&#39;, &#39;Author&#39;: &#39;Me&#39;, &#39;Title&#39;: &#39;Awesome&#39;}``.</span>

<span class="sd">            The standard keys are &#39;Title&#39;, &#39;Author&#39;, &#39;Subject&#39;, &#39;Keywords&#39;,</span>
<span class="sd">            &#39;Creator&#39;, &#39;Producer&#39;, &#39;CreationDate&#39;, &#39;ModDate&#39;, and</span>
<span class="sd">            &#39;Trapped&#39;. Values have been predefined for &#39;Creator&#39;, &#39;Producer&#39;</span>
<span class="sd">            and &#39;CreationDate&#39;. They can be removed by setting them to `None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputfile</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_figures</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_empty</span> <span class="o">=</span> <span class="n">keep_empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">(</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">canonical</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;creationdate&#39;</span><span class="p">:</span> <span class="s1">&#39;CreationDate&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;moddate&#39;</span><span class="p">:</span> <span class="s1">&#39;ModDate&#39;</span><span class="p">,</span>
                <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">canonical</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">cbook</span><span class="o">.</span><span class="n">warn_deprecated</span><span class="p">(</span>
                        <span class="s1">&#39;3.3&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Support for setting PDF metadata keys &#39;</span>
                        <span class="s1">&#39;case-insensitively is deprecated since </span><span class="si">%(since)s</span><span class="s1"> and &#39;</span>
                        <span class="s1">&#39;will be removed </span><span class="si">%(removal)s</span><span class="s1">; &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;set </span><span class="si">{</span><span class="n">canonical</span><span class="si">}</span><span class="s1"> instead of </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">canonical</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info_dict</span> <span class="o">=</span> <span class="n">_create_pdf_info_dict</span><span class="p">(</span><span class="s1">&#39;pgf&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>

        <span class="c1"># create temporary directory for compiling the figure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;mpl_pgf_pdfpages_&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_basename</span> <span class="o">=</span> <span class="s1">&#39;pdf_pages&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fname_tex</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basename</span> <span class="o">+</span> <span class="s2">&quot;.tex&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fname_pdf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basename</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fname_tex</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>

    <span class="nd">@cbook</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="s1">&#39;3.3&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

    <span class="k">def</span> <span class="nf">_write_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width_inches</span><span class="p">,</span> <span class="n">height_inches</span><span class="p">):</span>
        <span class="n">hyperref_options</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">_metadata_to_str</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="n">latex_preamble</span> <span class="o">=</span> <span class="n">get_preamble</span><span class="p">()</span>
        <span class="n">latex_fontspec</span> <span class="o">=</span> <span class="n">get_fontspec</span><span class="p">()</span>
        <span class="n">latex_header</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;\PassOptionsToPackage{{</span>
<span class="s2">  pdfinfo={{</span>
<span class="s2">    </span><span class="si">{metadata}</span><span class="s2"></span>
<span class="s2">  }}</span>
<span class="s2">}}{{hyperref}}</span>
<span class="s2">\RequirePackage{{hyperref}}</span>
<span class="s2">\documentclass[12pt]{{minimal}}</span>
<span class="s2">\usepackage[</span>
<span class="s2">    paperwidth=</span><span class="si">{width}</span><span class="s2">in,</span>
<span class="s2">    paperheight=</span><span class="si">{height}</span><span class="s2">in,</span>
<span class="s2">    margin=0in</span>
<span class="s2">]{{geometry}}</span>
<span class="si">{preamble}</span><span class="s2"></span>
<span class="si">{fontspec}</span><span class="s2"></span>
<span class="s2">\usepackage{{pgf}}</span>
<span class="s2">\setlength{{\parindent}}{{0pt}}</span>

<span class="s2">\begin{{document}}</span><span class="si">%%</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width_inches</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">height_inches</span><span class="p">,</span>
            <span class="n">preamble</span><span class="o">=</span><span class="n">latex_preamble</span><span class="p">,</span>
            <span class="n">fontspec</span><span class="o">=</span><span class="n">latex_fontspec</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">hyperref_options</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">latex_header</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="PdfPages.close"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.PdfPages.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize this object, running LaTeX in a temporary directory</span>
<span class="sd">        and moving the final pdf file to *filename*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;\end</span><span class="si">{document}</span><span class="s1">\n&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_figures</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_latex</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">TmpDirCleaner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_empty</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_run_latex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">texcommand</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;pgf.texsystem&quot;</span><span class="p">]</span>
        <span class="n">cbook</span><span class="o">.</span><span class="n">_check_and_log_subprocess</span><span class="p">(</span>
            <span class="p">[</span><span class="n">texcommand</span><span class="p">,</span> <span class="s2">&quot;-interaction=nonstopmode&quot;</span><span class="p">,</span> <span class="s2">&quot;-halt-on-error&quot;</span><span class="p">,</span>
             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fname_tex</span><span class="p">)],</span>
            <span class="n">_log</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="p">)</span>
        <span class="c1"># copy file contents to target</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fname_pdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputfile</span><span class="p">)</span>

<div class="viewcode-block" id="PdfPages.savefig"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.PdfPages.savefig">[docs]</a>    <span class="k">def</span> <span class="nf">savefig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a `.Figure` to this file as a new page.</span>

<span class="sd">        Any other keyword arguments are passed to `~.Figure.savefig`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        figure : `.Figure` or int, optional</span>
<span class="sd">            Specifies what figure is saved to file. If not specified, the</span>
<span class="sd">            active figure is saved. If a `.Figure` instance is provided, this</span>
<span class="sd">            figure is saved. If an int is specified, the figure instance to</span>
<span class="sd">            save is looked up by number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">Figure</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">manager</span> <span class="o">=</span> <span class="n">Gcf</span><span class="o">.</span><span class="n">get_active</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">manager</span> <span class="o">=</span> <span class="n">Gcf</span><span class="o">.</span><span class="n">get_fig_manager</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No figure </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">figure</span><span class="p">))</span>
            <span class="n">figure</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">figure</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">orig_canvas</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvasPgf</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>

            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_figures</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_header</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># \pdfpagewidth and \pdfpageheight exist on pdftex, xetex, and</span>
                <span class="c1"># luatex&lt;0.85; they were renamed to \pagewidth and \pageheight</span>
                <span class="c1"># on luatex&gt;=0.85.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">br</span><span class="s1">&#39;\newpage&#39;</span>
                    <span class="sa">br</span><span class="s1">&#39;\ifdefined\pdfpagewidth\pdfpagewidth&#39;</span>
                    <span class="sa">br</span><span class="s1">&#39;\else\pagewidth\fi=</span><span class="si">%a</span><span class="s1">in&#39;</span>
                    <span class="sa">br</span><span class="s1">&#39;\ifdefined\pdfpageheight\pdfpageheight&#39;</span>
                    <span class="sa">br</span><span class="s1">&#39;\else\pageheight\fi=</span><span class="si">%a</span><span class="s1">in&#39;</span>
                    <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%%</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pgf&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_figures</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">orig_canvas</span></div>

<div class="viewcode-block" id="PdfPages.get_pagecount"><a class="viewcode-back" href="../../../api/backend_pgf_api.html#matplotlib.backends.backend_pgf.PdfPages.get_pagecount">[docs]</a>    <span class="k">def</span> <span class="nf">get_pagecount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current number of pages in the multipage pdf file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_figures</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer>
    <div class="footer">
    &copy; Copyright 2002 - 2012 John Hunter, Darren Dale, Eric Firing, Michael Droettboom and the Matplotlib development team; 2012 - 2020 The Matplotlib development team.
<br />
    Last updated on Jul 12, 2020.
Created using
<a href="http://sphinx-doc.org/">Sphinx</a> 3.1.2.
Doc version v3.3.0rc1-229-g97785f2e6.
    </div>
</footer>
<script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-55954603-1', 'auto');
        ga('send', 'pageview');

</script>
  </body>
</html>